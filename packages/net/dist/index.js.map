{"version":3,"sources":["../src/index.ts","../src/fetch/index.ts","../src/ws/index.ts","../src/ws/contants.ts","../src/ws/handler/baseHandler.ts","../src/ws/handler/ping.ts","../src/ws/handler/handler.ts"],"sourcesContent":["export { get, post } from \"./fetch\";\n\nexport { default as WS } from \"./ws\";\n","async function request(url: string, options: RequestInit) {\n  if (!url.startsWith(\"http\")) {\n    throw new Error(\"url must start with http(s)\");\n  }\n  const urlInstance = new URL(url);\n  const response = await fetch(url, {\n    ...options,\n    headers: _createHeaders(options.headers),\n  });\n\n  if (response.ok) {\n    return response.json();\n  }\n  throw new Error(response.statusText);\n}\n\nfunction _createHeaders(headers: HeadersInit = {}): HeadersInit {\n  const _headers = new Headers(headers);\n  if (!_headers.has(\"Content-Type\")) {\n    _headers.append(\"Content-Type\", \"application/json\");\n  }\n\n  return _headers;\n}\n\nfunction get(url: string, options?: any): Promise<any> {\n  return request(url, {\n    method: \"GET\",\n  });\n}\nfunction post(url: string, data: any, options?: any): Promise<any> {\n  return request(url, {\n    method: \"POST\",\n    body: JSON.stringify(data),\n  });\n}\n\nexport { get, post };\n","import { type WebSocketSubject, webSocket } from \"rxjs/webSocket\";\n\nimport { WS_URL } from \"./contants\";\nimport { Observable, Observer, Subject, tap } from \"rxjs\";\nimport { messageHandlers } from \"@/ws/handler/handler\";\n\nexport type NetworkId = \"testnet\" | \"mainnet\";\n\nexport type WSOptions = {\n  url?: string;\n  networkId?: NetworkId;\n  accountId?: string;\n};\nclass WS {\n  private wsSubject: WebSocketSubject<any>;\n\n  private authenticated: boolean = false;\n\n  constructor(options: WSOptions) {\n    this.wsSubject = this.createSubject(options);\n\n    this.bindSubscribe();\n  }\n  private createSubject(options: WSOptions): WebSocketSubject<any> {\n    let url;\n    if (typeof options.url === \"string\") {\n      url = options.url;\n    } else {\n      url = WS_URL[options.networkId || \"testnet\"].public;\n    }\n\n    return webSocket({\n      url,\n      openObserver: {\n        next: () => {\n          console.log(\"Connection ok\");\n        },\n      },\n      closeObserver: {\n        next: () => {\n          console.log(\"Connection closed\");\n        },\n      },\n    });\n  }\n\n  private bindSubscribe() {\n    /// 处理ping,auth等消息\n    this.wsSubject.subscribe((message) => {\n      const handler = messageHandlers.get(message.event);\n      if (handler) {\n        handler.handle(message, this.send.bind(this));\n      }\n    });\n  }\n\n  private authenticate() {\n    if (this.authenticated) return;\n    this.wsSubject.next({ type: \"authenticate\" });\n    this.authenticated = true;\n  }\n\n  send(message: any) {\n    this.wsSubject.next(message);\n  }\n\n  observe<T>(topic: string): Observable<T>;\n  observe<T>(topic: string, unsubscribe?: () => any): Observable<T>;\n  observe<T>(\n    params: {\n      event: string;\n    } & Record<string, any>,\n    unsubscribe?: () => any\n  ): Observable<T>;\n  observe<T>(\n    params: any,\n    unsubscribe?: () => any,\n    messageFilter?: (value: T) => boolean\n  ): Observable<T> {\n    const [subscribeMessage, unsubscribeMessage, filter] = this.generateMessage(\n      params,\n      unsubscribe,\n      messageFilter\n    );\n\n    return new Observable((observer: Observer<T>) => {\n      try {\n        this.send(subscribeMessage);\n      } catch (err) {\n        observer.error(err);\n      }\n\n      const subscription = this.wsSubject.subscribe({\n        next: (x) => {\n          try {\n            if (filter(x)) {\n              observer.next(x);\n            }\n          } catch (err) {\n            observer.error(err);\n          }\n        },\n        error: (err) => observer.error(err),\n        complete: () => observer.complete(),\n      });\n\n      return () => {\n        try {\n          console.log(\"******* unsubscribe\", unsubscribeMessage);\n          if (!!unsubscribeMessage) {\n            this.send(unsubscribeMessage);\n          }\n        } catch (err) {\n          observer.error(err);\n        }\n        subscription.unsubscribe();\n      };\n    });\n  }\n\n  privateObserve(topic: string): Observable<any> {\n    return this.observe(topic);\n  }\n\n  private generateMessage(\n    params: any,\n    unsubscribe?: () => any,\n    messageFilter?: (value: any) => boolean\n  ): [Record<string, any>, Record<string, any>, (message: any) => boolean] {\n    let subscribeMessage: Record<string, any>,\n      unsubscribeMessage: Record<string, any>;\n    let filter: (message: any) => boolean;\n\n    if (typeof params === \"string\") {\n      subscribeMessage = { event: \"subscribe\", topic: params };\n      unsubscribeMessage = { event: \"unsubscribe\", topic: params };\n      filter = (message: any) => message.topic === params;\n    } else {\n      subscribeMessage = params;\n      unsubscribeMessage =\n        typeof unsubscribe === \"function\" ? unsubscribe() : unsubscribe;\n      filter = messageFilter || ((message: any) => true);\n    }\n\n    return [subscribeMessage, unsubscribeMessage, filter];\n  }\n}\n\nexport default WS;\n","export const WS_URL = {\n  testnet: {\n    public: \"wss://testnet-ws.orderly.org/ws/stream/\",\n    private: \"wss://testnet-ws-private.orderly.org/v2/ws/private/stream/\",\n  },\n  mainnet: {\n    public: \"wss://mainnet-ws.orderly.io\",\n    private: \"wss://mainnet-ws.orderly.io\",\n  },\n};\n","import { MessageHandler, SendFunc } from \"@/types/ws\";\nimport { WebSocketSubject } from \"rxjs/webSocket\";\n\nexport default class BaseHandler implements MessageHandler {\n  // constructor(readonly wsSubject: WebSocketSubject<any>) {}\n  handle(message: any, send: SendFunc) {\n    throw new Error(\"Method not implemented.\");\n  }\n}\n","import BaseHandler from \"./baseHandler\";\nimport { SendFunc } from \"@/types/ws\";\n\nexport default class PingHandler extends BaseHandler {\n  handle(_: any, send: SendFunc) {\n    send({ event: \"pong\", ts: Date.now() });\n  }\n}\n","import { MessageHandler } from \"@/types/ws\";\nimport PingHandler from \"./ping\";\n\nexport type MessageType =\n  | \"ping\"\n  | \"pong\"\n  | \"subscribe\"\n  | \"unsubscribe\"\n  | \"authenticate\"\n  | \"message\"\n  | \"error\"\n  | \"close\";\n\nexport const messageHandlers = new Map<MessageType, MessageHandler>([\n  [\"ping\", new PingHandler()],\n]);\n"],"mappings":"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","names":[]}