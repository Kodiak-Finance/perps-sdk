import { Callout } from "nextra/components";
import { CodeLive } from "@/components/doc/preview/codeLive";
import queryConfigRaw from "@/example/queryInfo.example";
import clientConfigRaw from "@/example/clientInfo.example";

# 请求 API 数据

Orderly 提供 Public API 和 Private API 两种接口，Public API 可以直接访问，Private API 需要身份验证及对数据签名,所有这些都可以由`@orderly.network/hooks`提供的 hook 来完成。

<Callout type="info">
  **温馨提示:** 通常情况下你不需要使用到以下这些hook,
  `@orderly.network/hooks`基于这些基础hook封装了更加简单易用的hook,比如仓位管理有[`usePositionStream`](/),创建订单有[`useOrderEntry`](/)等等，如果在[列表](/)中找不到想要的hook或者希望更灵活的使用Orderly
  API 时你才需要考虑使用以下这些hook。
</Callout>

## RESTful API

`@orderly.network/hooks` 提供了以下几种 hook 来方便开发者使用 RESTful API :

- [useQuery](/)
- [usePrivateQuery](/)
- [usePrivateInfiniteQuery](/)
- [useMutation](/)

以上 hook 均基于 [swr](https://swr.vercel.app/) 封装, 所以都具有以下特性:

- 缓存请求结果,根据配置优先使用缓存数据,可以当作全局状态管理使用
- 对网络请求去重，当请求参数相同时，自动取消重复的网络请求
- 窗口获得焦点或者网络恢复时，自动重新请求.
- 自动重试失败的网络请求
- ...更多特性可参考 [swr 官方文档](https://swr.vercel.app/)

### Public APIs

使用`useQuery`来请求 Public API, 例如获 Orderly 上的所有交易对:

<CodeLive code={queryConfigRaw} disabled />

`useQuery`返回的`data`字段是已经序列化成 JSON 格式的数据对象，如果需要后端返回的原始对象，可以提供一个`formatter`的函数替换 hook 默认的数据格式化方法，比如:

```typescript {4}
import { useQuery } from "@orderly.network/hooks";

const { data, error } = useQuery("/v1/public/info", {
  formatter: (data) => data,
});
```

### Private APIs

使用`usePrivateQuery`、`usePrivateInfiniteQuery`或者`useMutation`来请求 Private API, 相比`useQuery`有以下不同:

- 内置账号登录态检查，开发者无需检查当前用户的登录态，未登录时不会发起请求，当状态变成登录后才会发出网络请求
- 自动完成 OrderlyKey 签名

使用`usePrivateQuery`来请求 Private API, 例如获取当前用户的信息:

```typescript
const {usePrivateQuery} from "@orderly.network/hooks";

export const Example = ()=>{
  const {data,loading,error} = usePrivateQuery<API.AccountInfo>("/v1/client/info");
  //...
}
```

<CodeLive code={clientConfigRaw} disabled isPublic={false} />

### Mutation

**注意：无论`useQuery`或者`usePrivateQuery`都是发起`GET`类型的网络请求**, 如果需要发起`POST`、`PUT`、`DELETE`类型的网络请求，需要使用`useMutation`, 例如创建一个新的订单:

```typescript
import { useMutation } from "@orderly.network/hooks";

const [createOrder, { data, error, isMutating }] = useMutation<
  OrderEntity,
  any
>("/v1/order");
```

### 无限分页

仓位列表或者订单列表通常需要用到分页加载数据,如果想要实现无限滚动加载的效果，`usePrivateInfiniteQuery`可以帮助开发者完成这个需求。
**与普通的通过传递不同页码参数进行分页不同，`usePrivateInfiniteQuery`会将新页返回的数据追加到`data`，而不是替换**，例如获取当前用户的订单:

```typescript
const { data: orders } = usePrivateInfiniteQuery(
  (pageIndex: number, previousPageData) => {
    // reached the end
    if (previousPageData && !previousPageData.length) return null;

    const search = new URLSearchParams([
      ["size", size.toString()],
      ["page", `${pageIndex + 1}`],
    ]);

    // order status
    if (status) {
      search.set(`status`, status);
    }

    if (symbol) {
      search.set(`symbol`, symbol);
    }

    if (side) {
      search.set(`side`, side);
    }

    return `/v1/orders?${search.toString()}`;
  },
  {
    initialSize: 1,
    onError: (err) => {
      console.error("fetch failed::::", err);
    },
  }
);
```

<Callout>
  **为什么创建这么多网络类型的hooks,而不是通过参数来区分是`GET`或者`POST`呢？**
  <ul className="list-disc">
    <li>单一职责原则: 一个函数只做一件事</li>
    <li>降低代码的复杂度,防止因为副作用带来的不确定性</li>
  </ul>
</Callout>

## WebSocket

`@orderly.network/hooks`提供`useWS`hook 来方便开发者使用 WebSocket API, `useWS`返回的是`@orderly.network/net`中`WS`的实例，开发者可以通过`WS`实例来订阅、取消订阅、发送消息等操作，更多信息请参考[WS](/)。

所有可用的 topic 请参考[WebSocket API 文档](/api)。

### 订阅 Public 消息

```typescript
subscribe(
    topic: string|{[key:string]:any},
    callback: WSMessageHandler | Omit<WSMessageHandler, "onUnsubscribe">,
    once?: boolean,
    id?: string
  ): unsubscribe | undefined

```

订阅 trade 消息:

```typescript
import { useEffect } from "react";
import { useWS } from "@orderly.network/hooks";

export const Example = () => {
  const ws = useWS();

  useEffect(() => {
    const unsubscript = ws.subscribe(
      {
        id: `${symbol}@trade`,
        event: "subscribe",
        topic: `${symbol}@trade`,
        ts: Date.now(),
      },
      {
        onMessage: (data: any) => {
          //
        },
      }
    );
    () => {
      // 组件卸载时取消订阅
      unsubscribe();
    };
  }, []);

  //...
};
```

### 订阅 Private 消息

```typescript
subscribe(
    topic: string|{[key:string]:any},
    callback: WSMessageHandler | Omit<WSMessageHandler, "onUnsubscribe">,
    once?: boolean,
    id?: string
  ): unsubscribe | undefined

```

订阅`executionreport`消息:

```typescript
import { useWS } from "@orderly.network/hooks";

export const Example = () => {
  const ws = useWS();

  useEffect(() => {
    const unsubscript = ws.privateSubscribe(
      {
        id: "executionreport",
        event: "subscribe",
        topic: "executionreport",
        ts: Date.now(),
      },
      {
        onMessage: (data) => {
          // do something
        },
      }
    );
    () => {
      // 组件卸载时取消订阅
      unsubscribe();
    };
  }, []);

  //...
};
```
